import { PlanOption, Intake } from '@/types';

export const createGenerateMonthlyPrompt = (
  chosenPlan: PlanOption,
  intake: Intake
): string => {
  const {
    tier,
    track,
    daily_minutes,
    days_per_week,
    weeks,
    finish_date_est,
  } = chosenPlan;

  const { goal_free_text, cultural_mode } = intake;

  // æ ¹æ®å‘¨æ•°è®¡ç®—æœˆæ•°ï¼ˆæ¯4å‘¨ä¸º1ä¸ªæœˆï¼Œæœ€å°‘1ä¸ªæœˆï¼Œæœ€å¤š12ä¸ªæœˆï¼‰
  const monthsTotal = Math.max(1, Math.min(12, Math.ceil(weeks / 4)));

  return `è¯·åŸºäºŽé€‰å®šçš„å­¦ä¹ æ–¹æ¡ˆï¼Œç”Ÿæˆ${weeks}å‘¨è¯¦ç»†çš„æœˆåº¦è®¡åˆ’ï¼š

## å­¦å‘˜ä¿¡æ¯ - å…³é”®æ•°æ®
- **å­¦å‘˜èµ·ç‚¹æ°´å¹³**ï¼š${intake.self_assessed_level || 'æœªæä¾›'}
- **å­¦ä¹ ç›®æ ‡**ï¼š${goal_free_text}
- **ç›®æ ‡æ°´å¹³æŽ¨ç®—**ï¼šæ ¹æ®"${goal_free_text}"ï¼Œè¿™å¯¹åº”${goal_free_text.includes('æ¯è¯­') ? 'C1-C2' : goal_free_text.includes('èŒåœº') ? 'B2-C1' : goal_free_text.includes('å­¦æœ¯') ? 'B2-C1' : 'B1-B2'}æ°´å¹³

## é€‰å®šæ–¹æ¡ˆä¿¡æ¯
- **æ–¹æ¡ˆç­‰çº§**ï¼š${tier}
- **å­¦ä¹ è½¨é“**ï¼š${track}
- **å­¦ä¹ å¼ºåº¦**ï¼šæ¯æ—¥${daily_minutes}åˆ†é’Ÿï¼Œæ¯å‘¨${days_per_week}å¤©
- **æ€»å‘¨æœŸ**ï¼š${weeks}å‘¨ (${monthsTotal}ä¸ªæœˆ)
- **é¢„è®¡å®Œæˆ**ï¼š${finish_date_est}
- **æ–‡åŒ–æ¨¡å¼**ï¼š${cultural_mode}

## ðŸš¨ é‡è¦ï¼šéš¾åº¦é€’è¿›è¦æ±‚
- **å¦‚æžœå­¦å‘˜èµ·ç‚¹B2**ï¼šç¬¬1æœˆå¿…é¡»ä»ŽB2æˆ–B2+å¼€å§‹ï¼Œç»ä¸èƒ½å€’é€€åˆ°A2ï¼
- **å¦‚æžœç›®æ ‡æ¯è¯­æ°´å¹³**ï¼šæœ€ç»ˆåº”è¯¥è¾¾åˆ°C1-C2ï¼Œä¸æ˜¯B1ï¼
- **æ¯å‘¨é€’è¿›**ï¼šæ¯å‘¨æœ€å¤šæå‡1ä¸ªå¾®æ¡£ï¼Œåˆç†é€’è¿›

## è¾“å‡ºè¦æ±‚
è¯·è¿”å›žä¸¥æ ¼çš„JSONæ ¼å¼ï¼Œå¿…é¡»ç”Ÿæˆ${monthsTotal}ä¸ªæœˆçš„æ•°æ®ï¼š

\`\`\`json
{
  "months_total": ${monthsTotal},
  "milestones": [
${Array.from({ length: monthsTotal }, (_, i) => {
  const monthNum = i + 1;
  const isMonth1or2 = monthNum <= 2;
  const targetBand = "DYNAMIC"; // å¿…é¡»æ ¹æ®å­¦å‘˜èµ·ç‚¹å’Œç›®æ ‡åŠ¨æ€è®¡ç®—ï¼Œç»ä¸èƒ½ç¡¬ç¼–ç ï¼

  return `    {
      "month": ${monthNum},
      "max_target_band": "${targetBand}",
      "focus": ["é‡ç‚¹1", "é‡ç‚¹2", "é‡ç‚¹3", "é‡ç‚¹4"],
      "assessment_gate": {
        "accuracy": 0.8,
        "task_steps": ${isMonth1or2 ? 3 : 4},
        "fluency_pauses": 2
      }
    }${monthNum < monthsTotal ? ',' : ''}`;
}).join('\n')}
  ]
}
\`\`\`

TASK: Produce a MonthlyPlan with DYNAMIC caps based on start_band Ã— target_band Ã— total weeks.

## åŠ¨æ€æœˆåº¦ä¸Šé™è§„åˆ™

### éš¾åº¦é€’è¿›é€»è¾‘ - ä¿®å¤ç‰ˆæœ¬
- **èµ·ç‚¹æŽ¨å¯¼**ï¼šä»Žå­¦å‘˜self_assessed_levelèŽ·å–start_band (å®Œæ•´èŒƒå›´Pre-A..C1)
- **ç›®æ ‡æŽ¨å¯¼**ï¼šä»Žå­¦ä¹ ç›®æ ‡æŽ¨ç®—target_band (æ—¥å¸¸â‰ˆB1, èŒåœºâ‰ˆB2, å­¦æœ¯â‰ˆC1, æ¯è¯­â‰ˆC2)
- **ç¬¬1æœˆä¸Šé™**ï¼šstart_band + 1-2å¾®æ¡£ (ç»å¯¹ä¸èƒ½ä½ŽäºŽå­¦å‘˜èµ·ç‚¹ï¼)
- **åŽç»­æœˆä»½**ï¼šæ¯æœˆé€’è¿›â‰¤2å¾®æ¡£ï¼Œæ°¸ä¸è¶…è¿‡target_band
- **é¢„çƒ­æœºåˆ¶**ï¼šå…è®¸â‰¤10%æ—¶é—´ä½¿ç”¨ä¸‹ä¸€çº§è¯å—å†…å®¹ï¼ˆä»…çŸ­è¯­ï¼Œæ— æ®µè½ï¼‰
- **å‘¨å¢žé•¿é™åˆ¶**ï¼šæ¯å‘¨å¢žé•¿â‰¤1å¾®æ¡£ï¼Œè¶…é™å†…å®¹å¿…é¡»é‡å†™

### é‡è¦ä¿®å¤
- **B2èµ·ç‚¹å­¦å‘˜**ï¼šç¬¬1æœˆB2â†’B2+ï¼Œç¬¬2æœˆB2+â†’C1-ï¼Œç¬¬3æœˆC1-â†’C1ï¼Œç¬¬4æœˆC1â†’C1+
- **ç›®æ ‡æ¯è¯­æ°´å¹³**ï¼šæœ€ç»ˆç›®æ ‡æ˜¯C1-C2ï¼Œä¸æ˜¯B1ï¼
- **180èŠ‚è¯¾åˆ†é…**ï¼šåº”è¯¥ä»ŽB2å¼€å§‹é€’è¿›åˆ°C1-C2æ°´å¹³
- **ðŸš¨ ç»ä¸å€’é€€**ï¼šB2+ä¹‹åŽæ˜¯C1-ï¼Œä¸æ˜¯B1-ï¼

### è¯„ä¼°é—¸å£åŠ¨æ€è§„åˆ™
- **If current month cap < B1-** use A2 gate {accuracy:0.8, task_steps:3, fluency_pauses:2}
- **Else use B1 gate** {accuracy:0.8, task_steps:4, fluency_pauses:2}

## ä¼ ç»Ÿå‚è€ƒè§„åˆ™ï¼ˆå‘åŽå…¼å®¹ï¼‰

### ç¬¬1æœˆ
- **æ ¸å¿ƒç›®æ ‡**ï¼šå»ºç«‹åŸºç¡€äº¤æµèƒ½åŠ›
- **é‡ç‚¹é¢†åŸŸ**ï¼šæ ¹æ®${track}è½¨é“ç¡®å®šæ ¸å¿ƒæŠ€èƒ½
- **ä¸¥æ ¼é™åˆ¶**ï¼šåŸºäºŽåŠ¨æ€ä¸Šé™ï¼Œç»å¯¹ä¸å…è®¸è¶Šçº§

### ç¬¬2æœˆ
- **æ ¸å¿ƒç›®æ ‡**ï¼šæå‡äº¤æµæµç•…åº¦
- **å…è®¸é¢„çƒ­**ï¼šâ‰¤10%è¯å—çº§ä¸‹ä¸€çº§å†…å®¹ï¼ˆæ— æ®µè½çº§ï¼‰

### ç¬¬3æœˆ
- **æ ¸å¿ƒç›®æ ‡**ï¼šå¼€å§‹æŽ¥è§¦å¤æ‚å†…å®¹
- **é‡ç‚¹çªç ´**ï¼šæ®µè½çº§ç›®æ ‡å†…å®¹å¼€å§‹å¼•å…¥

### ç¬¬4æœˆ
- **æ ¸å¿ƒç›®æ ‡**ï¼šè¾¾åˆ°ç›®æ ‡æ°´å¹³
- **ç»¼åˆåº”ç”¨**ï¼šæ‰€æœ‰æŠ€èƒ½çš„æ•´åˆè¿ç”¨

## å­¦ä¹ è½¨é“é‡ç‚¹

### Work (èŒåœº)
- Month 1: åŸºç¡€èŒåœºè¯æ±‡ã€ç®€å•é‚®ä»¶æ ¼å¼
- Month 2: ç”µè¯æ²Ÿé€šã€ä¼šè®®åŸºç¡€è¡¨è¾¾
- Month 3: æ±‡æŠ¥æŠ€å·§ã€å•†åŠ¡è°ˆåˆ¤åŸºç¡€
- Month 4: æ¼”è®²æŠ€èƒ½ã€è·¨æ–‡åŒ–æ²Ÿé€š

### Travel (æ—…è¡Œ)
- Month 1: åŸºç¡€é—®è·¯ã€ç‚¹é¤ã€è´­ç‰©å¯¹è¯
- Month 2: äº¤é€šè¯¢é—®ã€é…’åº—æœåŠ¡ã€ç´§æ€¥æƒ…å†µ
- Month 3: æ·±åº¦äº¤æµã€æ–‡åŒ–ä½“éªŒã€åœ°é“è¡¨è¾¾
- Month 4: è‡ªåŠ©æ—…è¡Œã€é—®é¢˜è§£å†³ã€æ–‡åŒ–äº¤æµ

### Study (å­¦æœ¯)
- Month 1: è¯¾å ‚ç”¨è¯­ã€åŸºç¡€å­¦æœ¯è¯æ±‡
- Month 2: ä½œä¸šè®¨è®ºã€å°ç»„åˆä½œã€ç®€å•æ¼”è®²
- Month 3: ç ”ç©¶è®¨è®ºã€å­¦æœ¯å†™ä½œåŸºç¡€
- Month 4: å­¦æœ¯æŠ¥å‘Šã€æ‰¹åˆ¤æ€§æ€ç»´ã€å­¦æœ¯äº¤æµ

### Daily (æ—¥å¸¸)
- Month 1: è‡ªæˆ‘ä»‹ç»ã€å…´è¶£çˆ±å¥½ã€æ—¥å¸¸æ´»åŠ¨
- Month 2: å¤©æ°”è®¨è®ºã€è®¡åˆ’å®‰æŽ’ã€æƒ…æ„Ÿè¡¨è¾¾
- Month 3: è§‚ç‚¹åˆ†äº«ã€æ•…äº‹è®²è¿°ã€æ·±å…¥äº¤æµ
- Month 4: ç¤¾äº¤æŠ€å·§ã€æ–‡åŒ–ç†è§£ã€æµç•…å¯¹è¯

### Exam (è€ƒè¯•)
- Month 1: è€ƒè¯•è¯æ±‡ã€åŸºç¡€é¢˜åž‹æŠ€å·§
- Month 2: å¬åŠ›æŠ€å·§ã€é˜…è¯»ç­–ç•¥ã€å†™ä½œåŸºç¡€
- Month 3: å£è¯­æŠ€å·§ã€ç»¼åˆåº”ç”¨ã€æ¨¡æ‹Ÿæµ‹è¯•
- Month 4: å†²åˆºæŠ€å·§ã€å¿ƒç†è°ƒèŠ‚ã€è€ƒè¯•ç­–ç•¥

## è¯„ä¼°é—¸å£è¯´æ˜Ž
- **accuracy**: ä»»åŠ¡å®Œæˆå‡†ç¡®çŽ‡è¦æ±‚
- **task_steps**: ä»»åŠ¡å¤æ‚åº¦ï¼ˆæ­¥éª¤æ•°é‡ï¼‰
- **fluency_pauses**: å…è®¸çš„æ€è€ƒåœé¡¿æ¬¡æ•°

è¯·æ ¹æ®é€‰å®šçš„${tier}æ–¹æ¡ˆå’Œ${track}è½¨é“ï¼Œç”Ÿæˆè¯¦ç»†çš„${weeks}å‘¨æœˆåº¦è®¡åˆ’ã€‚ç¡®ä¿æ¯æœˆé‡ç‚¹æ˜Žç¡®ã€å¾ªåºæ¸è¿›ï¼Œå¹¶ä¸¥æ ¼éµå®ˆéš¾åº¦é€’è¿›è§„åˆ™ã€‚

**é‡è¦æç¤º**ï¼šassessment_gateä¸­çš„æ•°å€¼å°†æ ¹æ®max_target_bandç”±åŽç«¯åŠ¨æ€è®¡ç®—ï¼Œå½“å‰æä¾›çš„æ•°å€¼ä»…ä¸ºå ä½ç¬¦ã€‚è¯·é‡ç‚¹å…³æ³¨max_target_bandçš„æ­£ç¡®è®¾ç½®å’Œfocuså†…å®¹çš„åˆç†æ€§ã€‚`;
};