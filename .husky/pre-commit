#\!/usr/bin/env bash
# QuickPlacement é¢„æäº¤æ ¡éªŒé’©å­

echo "ğŸ” è¿è¡Œ QuickPlacement é¢„æäº¤æ ¡éªŒ..."

# æ£€æŸ¥æ˜¯å¦æœ‰é¢˜åº“ç›¸å…³çš„æ–‡ä»¶å˜æ›´
qb_files_changed=$(git diff --cached --name-only | grep -E "(qb_bank|qb_schema)" | wc -l)

if [ "$qb_files_changed" -gt 0 ]; then
  echo "ğŸ“‹ æ£€æµ‹åˆ°é¢˜åº“æ–‡ä»¶å˜æ›´ï¼Œè¿è¡Œå®Œæ•´æ ¡éªŒ..."

  # 1. ç±»å‹æ£€æŸ¥
  echo "  1ï¸âƒ£ è¿è¡Œç±»å‹æ£€æŸ¥..."
  npm run type-check
  if [ $? -ne 0 ]; then
    echo "âŒ TypeScript ç±»å‹æ£€æŸ¥å¤±è´¥"
    exit 1
  fi

  # 2. åˆåŒæµ‹è¯•
  echo "  2ï¸âƒ£ è¿è¡ŒåˆåŒæµ‹è¯•..."
  npm test -- --testNamePattern="qb_contract" --passWithNoTests
  if [ $? -ne 0 ]; then
    echo "âŒ åˆåŒæµ‹è¯•å¤±è´¥"
    exit 1
  fi

  # 3. é¢˜åº“æ ¡éªŒ
  echo "  3ï¸âƒ£ è¿è¡Œé¢˜åº“æ ¡éªŒ..."
  npx tsx scripts/validate-qb.ts
  if [ $? -ne 0 ]; then
    echo "âŒ é¢˜åº“æ ¡éªŒå¤±è´¥"
    exit 1
  fi

  echo "âœ… æ‰€æœ‰é¢˜åº“ç›¸å…³æ ¡éªŒé€šè¿‡"
else
  echo "â„¹ï¸  æœªæ£€æµ‹åˆ°é¢˜åº“æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡ä¸“é¡¹æ ¡éªŒ"
fi

# 4. åŸºç¡€æ ¡éªŒï¼ˆå§‹ç»ˆè¿è¡Œï¼‰
echo "  4ï¸âƒ£ è¿è¡ŒåŸºç¡€æ ¡éªŒ..."

# æ£€æŸ¥æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯
npm run build --silent
if [ $? -ne 0 ]; then
  echo "âŒ æ„å»ºæ£€æŸ¥å¤±è´¥"
  exit 1
fi

# æ£€æŸ¥æ˜¯å¦æœ‰ linting é”™è¯¯
if [ -f "eslint.config.mjs" ]; then
  npm run lint --silent
  if [ $? -ne 0 ]; then
    echo "âŒ ESLint æ£€æŸ¥å¤±è´¥"
    exit 1
  fi
fi

echo "ğŸ‰ é¢„æäº¤æ ¡éªŒé€šè¿‡ï¼"
exit 0
